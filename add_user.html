{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-user-plus"></i> Cadastrar Novo Usuário</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="userForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" id="name" name="name" required
                                       placeholder="Digite o nome completo" title="Nome completo do usuário">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="masp" class="form-label">MASP *</label>
                                <input type="text" class="form-control masp" id="masp" name="masp" required
                                       maxlength="8" pattern="[0-9]{8}" title="Número de 8 dígitos do MASP"
                                       placeholder="Digite o MASP (8 dígitos)">
                                <div class="form-text">8 dígitos numéricos</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" required
                                       placeholder="exemplo@hospital.com" title="Endereço de email do usuário">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="role" class="form-label">Cargo *</label>
                                <select class="form-select" id="role" name="role" required onchange="toggleCustomRole()" title="Selecione o cargo do usuário">
                                    <option value="">Selecione o cargo...</option>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Coordenador">Coordenador</option>
                                    <option value="Técnico">Técnico de Informática</option>
                                    <option value="Analista de Rede">Analista de Rede</option>
                                    <option value="Assistente">Assistente Administrativo</option>
                                    <option value="Recepcionista">Recepcionista</option>
                                    <option value="Estagiário">Estagiário</option>
                                    <option value="custom">+ Adicionar Novo Cargo</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="customRoleField" style="display: none;">
                        <label for="custom_role" class="form-label">Novo Cargo *</label>
                        <input type="text" class="form-control" id="custom_role" name="custom_role"
                               placeholder="Digite o nome do novo cargo" title="Digite o nome do novo cargo">
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Senha *</label>
                                <input type="password" class="form-control" id="password" name="password" required
                                       minlength="6" placeholder="Mínimo 6 caracteres" title="Senha de acesso com mínimo 6 caracteres">
                                <div class="form-text">Mínimo de 6 caracteres</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">Confirmar Senha *</label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required
                                       minlength="6" placeholder="Digite a senha novamente" title="Confirme a senha digitada acima">
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Cadastrar Usuário
                        </button>
                        <a href="{{ url_for('users_management') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('userForm');

    // Máscara para MASP (8 dígitos)
    function applyMaspMask(input) {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 8);
        });
    }

    // Aplicar máscara MASP
    document.querySelectorAll('.masp').forEach(applyMaspMask);

    // Limpar formulário quando a página carregar (após sucesso)
    if (window.performance && performance.navigation.type === performance.navigation.TYPE_RELOAD) {
        form.reset();
        toggleCustomRole();
    }

    // Validação do formulário
    form.addEventListener('submit', function(e) {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const masp = document.getElementById('masp').value;
        const roleSelect = document.getElementById('role');
        const customRoleField = document.getElementById('customRoleField');
        const customRole = document.getElementById('custom_role');

        if (password !== confirmPassword) {
            e.preventDefault();
            alert('As senhas não coincidem!');
            document.getElementById('confirm_password').focus();
            return;
        }

        // Validar MASP
        if (masp.length !== 8) {
            e.preventDefault();
            alert('MASP deve ter exatamente 8 dígitos!');
            document.getElementById('masp').focus();
            return;
        }

        // Validar cargo customizado
        if (roleSelect.value === 'custom' && (!customRole.value || customRole.value.trim() === '')) {
            e.preventDefault();
            alert('Por favor, digite o nome do novo cargo!');
            customRole.focus();
            return;
        }
    });
});

function toggleCustomRole() {
    const roleSelect = document.getElementById('role');
    const customRoleField = document.getElementById('customRoleField');
    const customRole = document.getElementById('custom_role');

    if (roleSelect.value === 'custom') {
        customRoleField.style.display = 'block';
        customRole.required = true;
    } else {
        customRoleField.style.display = 'none';
        customRole.required = false;
        customRole.value = '';
    }
}
</script>
{% endblock %}