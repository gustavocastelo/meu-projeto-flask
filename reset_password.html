{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow">
            <div class="card-header bg-success text-white text-center">
                <h4 class="mb-0"><i class="fas fa-key me-2"></i>Redefinir Senha</h4>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    Digite sua nova senha abaixo. Certifique-se de que ela tenha pelo menos 6 caracteres.
                </p>

                <form method="POST" id="resetPasswordForm">
                    <div class="mb-3">
                        <label for="new_password" class="form-label fw-semibold">Nova Senha</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input type="password" class="form-control" id="new_password" name="new_password"
                                   placeholder="Digite sua nova senha" required minlength="6">
                            <button type="button" class="input-group-text toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Mínimo de 6 caracteres</div>
                    </div>

                    <div class="mb-4">
                        <label for="confirm_password" class="form-label fw-semibold">Confirmar Nova Senha</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                                   placeholder="Confirme sua nova senha" required minlength="6">
                            <button type="button" class="input-group-text toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 fw-semibold py-2">
                        <i class="fas fa-save me-2"></i>Redefinir Senha
                    </button>
                </form>

                <hr class="my-4">

                <div class="text-center">
                    <a href="{{ url_for('login') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar para o login
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetPasswordForm');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const toggleButtons = document.querySelectorAll('.toggle-password');

    // Toggle password visibility
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const input = this.parentElement.querySelector('input');
            const icon = this.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });
    });

    // Validar força da senha em tempo real
    newPasswordInput.addEventListener('input', function() {
        validatePasswordStrength(this.value);
    });

    form.addEventListener('submit', function(e) {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showAlert('As senhas não coincidem!', 'danger');
            confirmPasswordInput.focus();
            return false;
        }

        if (newPassword.length < 6) {
            e.preventDefault();
            showAlert('A senha deve ter pelo menos 6 caracteres.', 'danger');
            newPasswordInput.focus();
            return false;
        }

        // Mostrar loading
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Redefinindo...';
        submitBtn.disabled = true;
    });

    function validatePasswordStrength(password) {
        const strengthBadge = document.getElementById('password-strength');
        if (!strengthBadge) return;

        let strength = 0;
        if (password.length >= 6) strength++;
        if (password.length >= 8) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;

        const strengthText = ['Muito fraca', 'Fraca', 'Regular', 'Boa', 'Forte', 'Muito forte'][strength];
        const strengthClass = ['danger', 'danger', 'warning', 'info', 'success', 'success'][strength];

        strengthBadge.textContent = strengthText;
        strengthBadge.className = `badge bg-${strengthClass} float-end`;
    }

    function showAlert(message, type) {
        // Remover alertas existentes
        const existingAlerts = document.querySelectorAll('.custom-alert');
        existingAlerts.forEach(alert => alert.remove());

        // Criar novo alerta
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} custom-alert alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        form.parentNode.insertBefore(alertDiv, form);

        // Auto-dismiss após 5 segundos
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        }, 5000);
    }

    // Focar no campo de nova senha
    newPasswordInput.focus();
});
</script>

<style>
.custom-alert {
    margin-bottom: 1rem;
    border-radius: 0.5rem;
}

.card {
    border: none;
    border-radius: 1rem;
}

.card-header {
    border-radius: 1rem 1rem 0 0 !important;
    padding: 1.5rem;
}

.input-group-text {
    background-color: #f8f9fa;
    border-right: none;
}

.toggle-password {
    cursor: pointer;
    background-color: #f8f9fa;
    border-left: none;
}

.toggle-password:hover {
    background-color: #e9ecef;
}

.form-control:focus + .input-group-text,
.form-control:focus ~ .input-group-text {
    border-color: #86b7fe;
    background-color: #f8f9fa;
}
</style>
{% endblock %}